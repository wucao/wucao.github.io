
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
    <title>MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息 | 叉叉哥的BLOG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wucao">
    

    
    <meta name="description" content="在TCP连接开始到结束连接，之间可能会多次传输数据，也就是服务器和客户端之间可能会在连接过程中互相传输多条消息。理想状况是一方每发送一条消息，另一方就立即接收到一条，也就是一次write对应一次read。但是，现实不总是按照剧本来走。 MINA官方文档节选：  TCP guarantess delivery of all packets in the correct order. But ther">
<meta name="keywords" content="Java,MINA,Netty,Twisted,TCP,Python">
<meta property="og:type" content="article">
<meta property="og:title" content="MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息">
<meta property="og:url" content="https://xxgblog.com/2014/08/21/mina-netty-twisted-2/index.html">
<meta property="og:site_name" content="叉叉哥的BLOG">
<meta property="og:description" content="在TCP连接开始到结束连接，之间可能会多次传输数据，也就是服务器和客户端之间可能会在连接过程中互相传输多条消息。理想状况是一方每发送一条消息，另一方就立即接收到一条，也就是一次write对应一次read。但是，现实不总是按照剧本来走。 MINA官方文档节选：  TCP guarantess delivery of all packets in the correct order. But ther">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://xxgblog.com/img/6ea88b40-0e83-11e9-ab14-d663bd873d93.jpg">
<meta property="og:image" content="https://xxgblog.com/img/9624ed68-7e8e-419c-a6c5-66faa8570bc5.jpg">
<meta property="og:updated_time" content="2019-01-02T11:43:35.359Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息">
<meta name="twitter:description" content="在TCP连接开始到结束连接，之间可能会多次传输数据，也就是服务器和客户端之间可能会在连接过程中互相传输多条消息。理想状况是一方每发送一条消息，另一方就立即接收到一条，也就是一次write对应一次read。但是，现实不总是按照剧本来走。 MINA官方文档节选：  TCP guarantess delivery of all packets in the correct order. But ther">
<meta name="twitter:image" content="https://xxgblog.com/img/6ea88b40-0e83-11e9-ab14-d663bd873d93.jpg">

    
    <link rel="alternative" href="/atom.xml" title="叉叉哥的BLOG" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/xxg.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/xxg.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="叉叉哥的BLOG">叉叉哥的BLOG</a></h1>
				<h2 class="blog-motto">Python毁一生，Java穷三代，两者皆不沾，必成高富帅！</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="https://github.com/wucao">GitHub</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索">
						<input type="hidden" name="q" value="site:xxgblog.com">
					</form>
					
					</li>
				</ul>
			</ul></nav>
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/21/mina-netty-twisted-2/" title="MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息" itemprop="url">MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息</a>
  </h1>
  <p class="article-time">
    <time datetime="2014-08-21T05:51:00.000Z" itemprop="datePublished"> 发表于 2014-08-21</time>

  </p>
</header>

	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#MINA"><span class="toc-number">1.</span> <span class="toc-text">MINA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netty"><span class="toc-number">2.</span> <span class="toc-text">Netty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Twisted"><span class="toc-number">3.</span> <span class="toc-text">Twisted</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#MINA、Netty、Twisted一起学系列"><span class="toc-number"></span> <span class="toc-text">MINA、Netty、Twisted一起学系列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码"><span class="toc-number">1.</span> <span class="toc-text">源码</span></a></li></ol>
		
		</li></div>
		
		<p>在TCP连接开始到结束连接，之间可能会多次传输数据，也就是服务器和客户端之间可能会在连接过程中互相传输多条消息。理想状况是一方每发送一条消息，另一方就立即接收到一条，也就是一次write对应一次read。但是，现实不总是按照剧本来走。</p>
<p>MINA官方文档节选：</p>
<blockquote>
<p>TCP guarantess delivery of all packets in the correct order. But there is no guarantee that one write operation on the sender-side will result in one read event on the receiving side. One call of IoSession.write(Object message) by the sender can result in multiple messageReceived(IoSession session, Object message) events on the receiver; and multiple calls of IoSession.write(Object message) can lead to a single messageReceived event.</p>
</blockquote>
<p>Netty官方文档节选：</p>
<blockquote>
<p>In a stream-based transport such as TCP/IP, received data is stored into a socket receive buffer. Unfortunately, the buffer of a stream-based transport is not a queue of packets but a queue of bytes. It means, even if you sent two messages as two independent packets, an operating system will not treat them as two messages but as just a bunch of bytes. Therefore, there is no guarantee that what you read is exactly what your remote peer wrote.</p>
</blockquote>
<p>上面两段话表达的意思相同：TCP是基于字节流的协议，它只能保证一方发送和另一方接收到的数据的字节顺序一致，但是，并不能保证一方每发送一条消息，另一方就能完整的接收到一条信息。有可能发送了两条对方将其合并成一条，也有可能发送了一条对方将其拆分成两条。所以在<a href="/2014/08/15/mina-netty-twisted-1/">上一篇博文</a>中的Demo，可以说是一个错误的示范。不过服务器和客户端在同一台机器上或者在局域网等网速很好的情况下，这种问题还是很难测试出来。</p>
<p>举个简单了例子（这个例子来源于Netty官方文档）：</p>
<p>消息发送方发送了三个字符串：<br><img src="/img/6ea88b40-0e83-11e9-ab14-d663bd873d93.jpg" alt="消息发送方"><br>但是接收方收到的可能是这样的：<br><img src="/img/9624ed68-7e8e-419c-a6c5-66faa8570bc5.jpg" alt="消息接收方"><br>那么问题就很严重了，接收方没法分开这三条信息了，也就没法解析了。</p>
<p>对此，MINA的官方文档提供了以下几种解决方案：</p>
<p><strong>1、use fixed length messages</strong></p>
<p>使用固定长度的消息。比如每个长度4字节，那么接收的时候按每条4字节拆分就可以了。</p>
<p><strong>2、use a fixed length header that indicates the length of the body</strong></p>
<p>使用固定长度的Header，Header中指定Body的长度（字节数），将信息的内容放在Body中。例如Header中指定的Body长度是100字节，那么Header之后的100字节就是Body，也就是信息的内容，100字节的Body后面就是下一条信息的Header了。</p>
<p><strong>3、using a delimiter; for example many text-based protocols append a newline (or CR LF pair) after every message</strong></p>
<p>使用分隔符。例如许多文本内容的协议会在每条消息后面加上换行符（CR LF，即”\r\n”），也就是一行一条消息。当然也可以用其他特殊符号作为分隔符，例如逗号、分号等等。</p>
<p>当然除了上面说到的3种方案，还有其他方案。有的协议也可能会同时用到上面多种方案。例如HTTP协议，Header部分用的是CR LF换行来区分每一条Header，而Header中用Content-Length来指定Body字节数。</p>
<p>下面，分别用MINA、Netty、Twisted自带的相关API实现按换行符CR LF来分割消息。</p>
<h3 id="MINA"><a href="#MINA" class="headerlink" title="MINA"></a>MINA</h3><p>MINA可以使用ProtocolCodecFilter来对发送和接收的二进制数据进行加工，如何加工取决于ProtocolCodecFactory或ProtocolEncoder、ProtocolDecoder，加工后在IoHandler中messageReceived事件函数获取的message就不再是IoBuffer了，而是你想要的其他类型，可以是字符串，Java对象。这里可以使用TextLineCodecFactory（ProtocolCodecFactory的一个实现类）实现CR LF分割消息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TcpServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		IoAcceptor acceptor = <span class="keyword">new</span> NioSocketAcceptor();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 添加一个Filter，用于接收、发送的内容按照"\r\n"分割</span></span><br><span class="line">		acceptor.getFilterChain().addLast(<span class="string">"codec"</span>,</span><br><span class="line">				<span class="keyword">new</span> ProtocolCodecFilter(<span class="keyword">new</span> TextLineCodecFactory(Charset.forName(<span class="string">"UTF-8"</span>), <span class="string">"\r\n"</span>, <span class="string">"\r\n"</span>)));</span><br><span class="line"></span><br><span class="line">		acceptor.setHandler(<span class="keyword">new</span> TcpServerHandle());</span><br><span class="line">		acceptor.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8080</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TcpServerHandle</span> <span class="keyword">extends</span> <span class="title">IoHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(IoSession session, Throwable cause)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		cause.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接收到新的数据</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(IoSession session, Object message)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 接收客户端的数据，这里接收到的不再是IoBuffer类型，而是字符串</span></span><br><span class="line">		String line = (String) message;</span><br><span class="line">		System.out.println(<span class="string">"messageReceived:"</span> + line);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"sessionCreated"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionClosed</span><span class="params">(IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"sessionClosed"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h3><p>Netty设计上和MINA类似，需要在ChannelPipeline加上一些ChannelHandler用来对原始数据进行处理。这里用LineBasedFrameDecoder将接收到的数据按行分割，StringDecoder再将数据由字节码转成字符串。同样，接收到的数据进过加工后，在channelRead事件函数中，msg参数不再是ByteBuf而是String。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TcpServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">		EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">			b.group(bossGroup, workerGroup)</span><br><span class="line">					.channel(NioServerSocketChannel.class)</span><br><span class="line">					.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">						<span class="meta">@Override</span></span><br><span class="line">						<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span></span></span><br><span class="line"><span class="function">								<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">							ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">							<span class="comment">// LineBasedFrameDecoder按行分割消息</span></span><br><span class="line">							pipeline.addLast(<span class="keyword">new</span> LineBasedFrameDecoder(<span class="number">80</span>));</span><br><span class="line">							<span class="comment">// 再按UTF-8编码转成字符串</span></span><br><span class="line">							pipeline.addLast(<span class="keyword">new</span> StringDecoder(CharsetUtil.UTF_8));</span><br><span class="line"></span><br><span class="line">							pipeline.addLast(<span class="keyword">new</span> TcpServerHandler());</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;);</span><br><span class="line">			ChannelFuture f = b.bind(<span class="number">8080</span>).sync();</span><br><span class="line">			f.channel().closeFuture().sync();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			workerGroup.shutdownGracefully();</span><br><span class="line">			bossGroup.shutdownGracefully();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TcpServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接收到新的数据</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// msg经过StringDecoder后类型不再是ByteBuf而是String</span></span><br><span class="line">		String line = (String) msg;</span><br><span class="line">		System.out.println(<span class="string">"channelRead:"</span> + line);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"channelActive"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"channelInactive"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;</span><br><span class="line">		cause.printStackTrace();</span><br><span class="line">		ctx.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Twisted"><a href="#Twisted" class="headerlink" title="Twisted"></a>Twisted</h3><p>Twisted的设计和上面两者的设计不太一样，所以实现消息分割也不太一样。处理事件的类TcpServerHandle不再继承Protocol，而是继承Protocol的子类LineOnlyReceiver。接收到新数据的事件方法也不再是dataReceived，而是LineOnlyReceiver提供的lineReceived。看Twisted源码的话可以发现LineOnlyReceiver的内部实际上自己实现了dataReceived，然后将其按行分割，有新的一行数据就调用lineReceived。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 –*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> twisted.protocols.basic <span class="keyword">import</span> LineOnlyReceiver</span><br><span class="line"><span class="keyword">from</span> twisted.internet.protocol <span class="keyword">import</span> Factory</span><br><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TcpServerHandle</span><span class="params">(LineOnlyReceiver)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新的连接建立</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionMade</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'connectionMade'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 连接断开</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionLost</span><span class="params">(self, reason)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'connectionLost'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收到新的一行数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lineReceived</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'lineReceived:'</span> + data</span><br><span class="line"></span><br><span class="line">factory = Factory()</span><br><span class="line">factory.protocol = TcpServerHandle</span><br><span class="line">reactor.listenTCP(<span class="number">8080</span>, factory)</span><br><span class="line">reactor.run()</span><br></pre></td></tr></table></figure></p>
<p>下面用一个Java客户端对三个服务器进行测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TcpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Socket socket = <span class="keyword">null</span>;</span><br><span class="line">		OutputStream out = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">			socket = <span class="keyword">new</span> Socket(<span class="string">"localhost"</span>, <span class="number">8080</span>);</span><br><span class="line">			out = socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 请求服务器</span></span><br><span class="line">			String lines = <span class="string">"床前明月光\r\n疑是地上霜\r\n举头望明月\r\n低头思故乡\r\n"</span>;</span><br><span class="line">			<span class="keyword">byte</span>[] outputBytes = lines.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">			out.write(outputBytes);</span><br><span class="line">			out.flush();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 关闭连接</span></span><br><span class="line">			out.close();</span><br><span class="line">			socket.close();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MINA服务器输出结果：</p>
<p><em>sessionCreated</em><br><em>messageReceived:床前明月光</em><br><em>messageReceived:疑是地上霜</em><br><em>messageReceived:举头望明月</em><br><em>messageReceived:低头思故乡</em><br><em>sessionClosed</em></p>
<p>Netty服务器输出结果：</p>
<p><em>channelActive</em><br><em>channelRead:床前明月光</em><br><em>channelRead:疑是地上霜</em><br><em>channelRead:举头望明月</em><br><em>channelRead:低头思故乡</em><br><em>channelInactive</em></p>
<p>Twisted服务器输出结果：</p>
<p><em>connectionMade</em><br><em>lineReceived:床前明月光</em><br><em>lineReceived:疑是地上霜</em><br><em>lineReceived:举头望明月</em><br><em>lineReceived:低头思故乡</em><br><em>connectionLost</em></p>
<p>当然，测试的时候也可以将发送的数据模拟成不按规则分割的情况，下面用一个更变态的客户端来测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TcpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Socket socket = <span class="keyword">null</span>;</span><br><span class="line">		OutputStream out = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">			socket = <span class="keyword">new</span> Socket(<span class="string">"localhost"</span>, <span class="number">8080</span>);  </span><br><span class="line">			out = socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">			String lines = <span class="string">"床前"</span>;</span><br><span class="line">			<span class="keyword">byte</span>[] outputBytes = lines.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">			out.write(outputBytes);</span><br><span class="line">			out.flush();</span><br><span class="line"></span><br><span class="line">			Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">			lines = <span class="string">"明月"</span>;</span><br><span class="line">			outputBytes = lines.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">			out.write(outputBytes);</span><br><span class="line">			out.flush();</span><br><span class="line"></span><br><span class="line">			Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">			lines = <span class="string">"光\r\n疑是地上霜\r\n举头"</span>;</span><br><span class="line">			outputBytes = lines.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">			out.write(outputBytes);</span><br><span class="line">			out.flush();</span><br><span class="line"></span><br><span class="line">			Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">			lines = <span class="string">"望明月\r\n低头思故乡\r\n"</span>;</span><br><span class="line">			outputBytes = lines.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">			out.write(outputBytes);</span><br><span class="line">			out.flush();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 关闭连接</span></span><br><span class="line">			out.close();</span><br><span class="line">			socket.close();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再次分别测试上面三个服务器，结果和上面的输出结果一样，没有任何问题。</p>
<h2 id="MINA、Netty、Twisted一起学系列"><a href="#MINA、Netty、Twisted一起学系列" class="headerlink" title="MINA、Netty、Twisted一起学系列"></a>MINA、Netty、Twisted一起学系列</h2><p><a href="http://xxgblog.com/2014/08/15/mina-netty-twisted-1/">MINA、Netty、Twisted一起学（一）：实现简单的TCP服务器</a></p>
<p><a href="http://xxgblog.com/2014/08/21/mina-netty-twisted-2/">MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息</a></p>
<p><a href="http://xxgblog.com/2014/08/22/mina-netty-twisted-3/">MINA、Netty、Twisted一起学（三）：TCP消息固定大小的前缀(Header)</a></p>
<p><a href="http://xxgblog.com/2014/08/25/mina-netty-twisted-4/">MINA、Netty、Twisted一起学（四）：定制自己的协议</a></p>
<p><a href="http://xxgblog.com/2014/08/27/mina-netty-twisted-5/">MINA、Netty、Twisted一起学（五）：整合protobuf</a></p>
<p><a href="http://xxgblog.com/2014/09/10/mina-netty-twisted-6/">MINA、Netty、Twisted一起学（六）：session</a></p>
<p><a href="http://xxgblog.com/2014/09/19/mina-netty-twisted-7/">MINA、Netty、Twisted一起学（七）：发布/订阅（Publish/Subscribe）</a></p>
<p><a href="http://xxgblog.com/2014/09/23/mina-netty-twisted-8/">MINA、Netty、Twisted一起学（八）：HTTP服务器</a></p>
<p><a href="http://xxgblog.com/2014/10/12/mina-netty-twisted-9/">MINA、Netty、Twisted一起学（九）：异步IO和回调函数</a></p>
<p><a href="http://xxgblog.com/2014/10/16/mina-netty-twisted-10/">MINA、Netty、Twisted一起学（十）：线程模型</a></p>
<p><a href="http://xxgblog.com/2017/02/27/mina-netty-twisted-11/">MINA、Netty、Twisted一起学（十一）：SSL/TLS</a></p>
<p><a href="http://xxgblog.com/2017/02/28/mina-netty-twisted-12/">MINA、Netty、Twisted一起学（十二）：HTTPS</a></p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><a href="https://github.com/wucao/mina-netty-twisted" target="_blank" rel="noopener">https://github.com/wucao/mina-netty-twisted</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/异步网络编程/">异步网络编程</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Java/">Java</a><a href="/tags/MINA/">MINA</a><a href="/tags/Netty/">Netty</a><a href="/tags/Twisted/">Twisted</a><a href="/tags/TCP/">TCP</a><a href="/tags/Python/">Python</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://xxgblog.com/2014/08/21/mina-netty-twisted-2/" data-title="MINA、Netty、Twisted一起学（二）：TCP消息边界问题及按行分割消息 | 叉叉哥的BLOG" data-tsina class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/2014/08/22/mina-netty-twisted-3/" title="MINA、Netty、Twisted一起学（三）：TCP消息固定大小的前缀(Header)">
  <strong>上一篇：</strong><br>
  <span>
  MINA、Netty、Twisted一起学（三）：TCP消息固定大小的前缀(Header)</span>
</a>
</div>


<div class="next">
<a href="/2014/08/15/mina-netty-twisted-1/" title="MINA、Netty、Twisted一起学（一）：实现简单的TCP服务器">
 <strong>下一篇：</strong><br> 
 <span>MINA、Netty、Twisted一起学（一）：实现简单的TCP服务器
</span>
</a>
</div>

</nav>

	




<div id="gitalk-container" style="padding: 0 4%;"></div>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#MINA"><span class="toc-number">1.</span> <span class="toc-text">MINA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netty"><span class="toc-number">2.</span> <span class="toc-text">Netty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Twisted"><span class="toc-number">3.</span> <span class="toc-text">Twisted</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#MINA、Netty、Twisted一起学系列"><span class="toc-number"></span> <span class="toc-text">MINA、Netty、Twisted一起学系列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码"><span class="toc-number">1.</span> <span class="toc-text">源码</span></a></li></ol>
 
  </li></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/Jetty/" title="Jetty">Jetty<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Maven/" title="Maven">Maven<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/MyBatis/" title="MyBatis">MyBatis<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Node-js/" title="Node.js">Node.js<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spring-Framework/" title="Spring Framework">Spring Framework<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Struts-2/" title="Struts 2">Struts 2<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/XMPP/" title="XMPP">XMPP<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/异步网络编程/" title="异步网络编程">异步网络编程<sup>12</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/MINA/" title="MINA">MINA<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Twisted/" title="Twisted">Twisted<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/TCP/" title="TCP">TCP<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Maven/" title="Maven">Maven<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-Framework/" title="Spring Framework">Spring Framework<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/线程/" title="线程">线程<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Nginx/" title="Nginx">Nginx<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/protobuf/" title="protobuf">protobuf<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Jetty/" title="Jetty">Jetty<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/XMPP/" title="XMPP">XMPP<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Tigase/" title="Tigase">Tigase<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Tomcat/" title="Tomcat">Tomcat<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-Security/" title="Spring Security">Spring Security<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Struts-2/" title="Struts 2">Struts 2<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>2</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://lovecindywang.cnblogs.com/" target="_blank" title="朱晔的博客">朱晔的博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://blackcoffee2016.github.io/" target="_blank" title="杨灿的博客">杨灿的博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://opstrip.com/" target="_blank" title="石尧的博客">石尧的博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.itcodai.com/" target="_blank" title="倪升武的博客">倪升武的博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://blog.csdn.net/noaman_wgs" target="_blank" title="王根深的博客">王根深的博客</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.cnblogs.com/jy107600" target="_blank" title="蒋宇的博客">蒋宇的博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://youngforzy.top/" target="_blank" title="曾勇的博客">曾勇的博客</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer">
	
	
	<div class="social-font">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="wucao">wucao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});
</script>








<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script type="text/javascript">
const gitalk = new Gitalk({
  clientID: 'ce21dd1e4d8a2819290e',
  clientSecret: 'f0786f8810407db32800529b6533331d672c6eff',
  repo: 'xxg-blog-message-board',
  owner: 'wucao',
  admin: ['wucao'],
  id: location.pathname.split('/')[4]
});
$(document).ready(function() {
  gitalk.render('gitalk-container');
});
</script>





<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<div style="height: 0px; overflow: hidden">
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254684152'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1254684152' type='text/javascript'%3E%3C/script%3E"));</script>
</div>


<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
